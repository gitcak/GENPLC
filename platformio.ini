; PlatformIO Recovery Build Configuration
; 
; Emergency stabilization build for GENPLC project
; Addresses mutex contention, memory pressure, and cellular connectivity issues
;
; Key changes from main platformio.ini:
; - Reduced memory usage and optimization
; - Simplified task configuration
; - Emergency debugging enabled
; - Recovery-specific build flags

[platformio]
default_envs = m5stamps3-recovery

[env:m5stamps3-recovery]
platform = espressif32
board = m5stack-stamps3
framework = arduino

; Build configuration for recovery
build_type = debug
build_unflags = -Os
build_flags =
    -O2 -g
    -Wno-deprecated-declarations
    -ffunction-sections -fdata-sections
    -Wl,--gc-sections
    -DCORE_DEBUG_LEVEL=3
    -DARDUINO_USB_CDC_ON_BOOT=0
    -DTINYGSM_MODEM_SIM7000=1
    -DTINYGSM_MODEM_SIM7080=1
    -DRECOVERY_MODE=1
    -DENABLE_RECOVERY_BUILD=1
    -DMAX_RETRY_ATTEMPTS=3
    -DMEMORY_EMERGENCY_THRESHOLD=1024
    -DWATCHDOG_TIMEOUT_MS=30000
    -I src/config
    -I src/hardware
    -I src/modules
    -I src/ui
    -I include

; Source filter - recovery only
build_src_filter =
    +<main_recovery.cpp>
    +<string_pool.cpp>
    +<hardware/>
    +<modules/catm_gnss/>
    +<modules/logging/>
    +<modules/storage/sd_card_module.cpp>
    +<system/>
    +<ui/>
    +<config/>
    +<../include/>
    -<main.cpp>
    -<main_recovery.ino>
    -<system/memory_test.cpp>
    -<modules/pwrcan/>
    -<modules/settings/>
    -<modules/storage/storage_task.cpp>
    -<modules/transport/>
    -<modules/cellular/>

; Optimized for no-PSRAM StampS3A
board_build.partitions = default.csv
board_build.arduino.memory_type = qio_qspi
board_build.psram = disabled
board_build.f_cpu = 240000000L
board_build.flash_mode = qio
board_build.flash_size = 8MB
board_build.arduino.usb_mode = 0
board_build.arduino.usb_cdc_on_boot = 0
board_build.arduino.heap_type = 1
board_build.arduino.heap_size = 196608
board_build.arduino.optimization = -O2
board_build.arduino.debug_level = 3

; Local libraries path (M5_SIM7080G modular library)
lib_extra_dirs = libraries

; Essential libraries only (reduced dependency chain)
lib_deps =
    m5stack/M5StamPLC@^1.1.0
    mikalhart/TinyGPSPlus@^1.1.0
    bblanchon/ArduinoJson@^7

; Monitoring configuration
monitor_speed = 115200
monitor_filters = esp32_exception_decoder, time, colorize
upload_speed = 115200
upload_protocol = esptool
upload_flags =
    --before=default_reset
    --after=hard_reset

; Debug configuration
debug_tool = esp-builtin
debug_init_break = tbreak setup
debug_extra_cmds =
    set remote hardware-watchpoint-limit 2
    set remote hardware-breakpoint-limit 2
debug_server =
    $PLATFORMIO_CORE_DIR/packages/tool-openocd-esp32/bin/openocd
    -s
    $PLATFORMIO_CORE_DIR/packages/tool-openocd-esp32/share/openocd/scripts
    -f
    board/esp32s3-builtin.cfg
debug_port = 3333
debug_load_mode = manual

; Static analysis with recovery-specific suppressions
check_tool = cppcheck
check_flags =
    --suppress=missingIncludeSystem
    --suppress=unusedFunction
    --suppress=uninitMemberVar
    --suppress=noExplicitConstructor
    --suppress=cstyleCast
    --suppress=passedByValue
    --suppress=constParameterPointer
    --suppress=constVariablePointer
    --suppress=shadowFunction
    --suppress=duplInheritedMember
    --suppress=missingOverride
    --suppress=unusedPrivateFunction
    --suppress=legacyUninitvar
    --suppress=preprocessorErrorDirective
    --suppress=*:.pio/libdeps/*
    --suppress=*:ArduinoJson/*
    --suppress=*:TinyGPSPlus/*
    --suppress=*:TinyGSM/*
    --suppress=*:M5Unified/*
    --suppress=*:M5StamPLC/*
    --suppress=*:M5Unit-CatM/*
    --enable=all
    --inconclusive

; Recovery-specific patches
extra_scripts =
    pre:scripts/patch_m5stamplc_ina226.py

; Alternative build configurations for testing
[env:m5stamps3-cellular-test]
platform = espressif32
board = m5stack-stamps3
framework = arduino
build_type = debug
build_flags =
    -O0 -g
    -DCORE_DEBUG_LEVEL=5
    -DTINYGSM_MODEM_SIM7000=1
    -DTINYGSM_MODEM_SIM7080=1
    -DCELLULAR_TEST_ONLY=1
build_src_filter = +<cellular_test.cpp>
lib_extra_dirs = libraries
lib_deps =
    m5stack/M5StamPLC@^1.1.0
    mikalhart/TinyGPSPlus@^1.1.0
board_build.partitions = default.csv
board_build.arduino.memory_type = qio_qspi
board_build.psram = disabled
monitor_speed = 115200
monitor_filters = esp32_exception_decoder, time, colorize

[env:m5stamps3-memory-test]
platform = espressif32
board = m5stack-stamps3
framework = arduino
build_type = debug
build_flags =
    -Os -g
    -DCORE_DEBUG_LEVEL=4
    -DMEMORY_TEST_MODE=1
    -I src/config
build_src_filter = +<system/memory_test.cpp> +<../include/>
lib_deps =
    m5stack/M5StamPLC@^1.1.0
board_build.partitions = default.csv
board_build.arduino.memory_type = qio_qspi
board_build.psram = disabled
monitor_speed = 115200
monitor_filters = esp32_exception_decoder, time, colorize
