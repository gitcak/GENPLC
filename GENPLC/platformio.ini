; PlatformIO Project Configuration File
;
;   Build options: build flags, source filter
;   Upload options: custom upload port, speed and extra flags
;   Library options: dependencies, extra library storages
;   Advanced options: extra scripting
;
; Please visit documentation for the other options and examples
; https://docs.platformio.org/page/projectconf.html

[platformio]
default_envs = m5stack-stamps3-freertos

[env:m5stack-stamps3-freertos]
platform = espressif32
board = m5stack-stamps3
framework = arduino
board_build.partitions = default.csv
; StampS3A has no PSRAM; use QSPI flash config and disable PSRAM
board_build.arduino.memory_type = qio_qspi
board_build.psram = disabled
board_build.f_cpu = 240000000L
board_build.flash_mode = qio
board_build.flash_size = 8MB
board_build.arduino.usb_mode = 0
board_build.arduino.usb_cdc_on_boot = 0
board_build.arduino.heap_type = 1
board_build.arduino.heap_size = 196608
board_build.arduino.optimization = -O2
board_build.arduino.debug_level = 5
board_build.arduino.arduino_log_level = 5
build_type = debug
build_unflags = -Os
build_flags = 
	-O2 -g
	-Wno-deprecated-declarations
	-ffunction-sections -fdata-sections
	-Wl,--gc-sections
	-DCORE_DEBUG_LEVEL=5
	-DARDUINO_USB_CDC_ON_BOOT=0
	-DTINYGSM_MODEM_SIM7000=1
	-DTINYGSM_MODEM_SIM7080=1
	-I src/config
	-I src/hardware
	-I src/communication
	-I src/application
	-I include
build_src_filter = +<*> -<sim/**> -<unused/**> -<**/ui_glue/**> +<src/debug_system.cpp>
lib_deps = 
	m5stack/M5Unified@^0.2.8
	m5stack/M5StamPLC@^1.0.0
	tinyu-zhao/M5Unit-CatM@^0.0.1
	vshymanskyy/TinyGSM@^0.12.0
	mikalhart/TinyGPSPlus@^1.1.0
	bblanchon/ArduinoJson@^7
	adafruit/Adafruit Unified Sensor@^1.1.9
	adafruit/Adafruit BusIO@^1.14.1
	adafruit/Adafruit BME280 Library@^2.2.2
	adafruit/Adafruit ADS1X15@^2.5.0
	knolleary/PubSubClient@^2.8
	developer-39/Simple QR Code@^0.9.0
	greiman/SdFat@^2.2.2
; No ignored libraries
monitor_speed = 115200
monitor_filters = esp32_exception_decoder, time, colorize
upload_speed = 115200
upload_protocol = esptool
upload_flags = 
	--before=default_reset
	--after=hard_reset
debug_tool = esp-builtin
debug_init_break = tbreak setup
debug_extra_cmds = 
	set remote hardware-watchpoint-limit 2
	set remote hardware-breakpoint-limit 2
debug_server = 
	$PLATFORMIO_CORE_DIR/packages/tool-openocd-esp32/bin/openocd
	-s
	$PLATFORMIO_CORE_DIR/packages/tool-openocd-esp32/share/openocd/scripts
	-f
	board/esp32s3-builtin.cfg
debug_port = 3333
debug_load_mode = manual
check_tool = cppcheck
check_flags = 
	--suppress=missingIncludeSystem
	--suppress=unusedFunction
	--suppress=uninitMemberVar
	--suppress=noExplicitConstructor
	--suppress=cstyleCast
	--suppress=passedByValue
	--suppress=constParameterPointer
	--suppress=constVariablePointer
	--suppress=shadowFunction
	--suppress=duplInheritedMember
	--suppress=missingOverride
	--suppress=unusedPrivateFunction
	--suppress=legacyUninitvar
	--suppress=preprocessorErrorDirective
	--suppress=*:.pio/libdeps/*
	--suppress=*:ArduinoJson/*
	--suppress=*:M5GFX/*
	--suppress=*:TinyGPSPlus/*
	--suppress=*:TinyGSM/*
	--suppress=*:M5Unified/*
	--suppress=*:M5StamPLC/*
	--suppress=*:M5Unit-CatM/*
	--suppress=*:Adafruit_*

# Build-time patches and fixes for vendor libraries
# Rationale:
# - patch_m5stamplc_ina226.py: Fixes M5StamPLC INA226 API compatibility with M5Unified 0.2.x
#   TODO: Remove when upstream M5StamPLC releases updated API usage (M5Unified 0.2.x compatibility)
# Note: SquareLine/LVGL sources have been archived under unused/lvgl/
extra_scripts = 
	pre:scripts/patch_m5stamplc_ina226.py
